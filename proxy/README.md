# V2Ray 代理安装模块

V2Ray 完整版安装脚本，支持VMess、VLESS、Shadowsocks协议，具备完整的服务器管理和订阅切换功能。

## 功能特性

- ✅ **多协议支持**: VMess、VLESS、Shadowsocks
- ✅ **智能订阅解析**: 自动解析多种格式订阅链接
- ✅ **服务器管理**: 节点切换、状态监控、自动重连
- ✅ **代理模式**: 本机代理 / 局域网共享
- ✅ **安全认证**: 支持用户名密码认证
- ✅ **DNS优化**: 国内DNS优化配置
- ✅ **智能路由**: 分流规则，国内外流量智能处理

## 快速使用

### 安装 V2Ray

```bash
# 进入v2ray目录
cd proxy/v2ray

# 运行安装脚本
./install_v2ray.sh
```

### 基本管理命令

安装完成后，可使用以下别名命令（需要 `source ~/.bashrc` 生效）：

```bash
# 服务管理
v2start          # 启动V2Ray
v2stop           # 停止V2Ray
v2restart        # 重启V2Ray
v2status         # 查看状态
v2log            # 查看日志

# 服务器管理
v2switch         # 切换服务器
v2list           # 列出所有服务器
v2vmess          # 列出VMess服务器
v2vless          # 列出VLESS服务器
v2ss             # 列出Shadowsocks服务器

# 订阅管理
v2update         # 更新订阅
v2scan           # 重新解析订阅

# 代理连接
v2connect        # 快速连接代理
proxy_on         # 开启代理
proxy_off        # 关闭代理
proxy_status     # 查看代理状态
```

## 安装步骤

### 1. 环境检查

脚本会自动检查：
- 操作系统兼容性
- 系统架构支持
- 必要命令工具
- 网络连接状态

### 2. 订阅配置

支持以下订阅格式：
- **VMess**: `vmess://[base64编码的配置]`
- **VLESS**: `vless://[UUID]@[服务器]:[端口]?[参数]`
- **Shadowsocks**: `ss://[base64编码的配置]`

### 3. 代理模式选择

- **本机代理**: 仅本机使用，监听 127.0.0.1
- **局域网共享**: 局域网设备可使用，支持认证

### 4. 自动配置生成

根据选择的服务器和代理模式，自动生成最优配置文件。

## 配置说明

### 代理端口配置

| 代理类型 | 端口 | 用途 |
|---------|------|------|
| SOCKS5  | 1080 | 通用代理协议 |
| HTTP    | 8080 | HTTP代理协议 |

### DNS配置

- **国内DNS**: 223.5.5.5 (阿里云)
- **备用DNS**: 114.114.114.114
- **国外DNS**: 8.8.8.8 (Google)
- **分流规则**: 国内外流量智能分流

### 路由规则

- **直连**: 私有IP、国内IP、国内域名
- **代理**: 国外IP和域名
- **策略**: IPOnDemand 智能选择

## 文件结构

安装完成后，V2Ray 的工作目录位于 `~/v2ray/`：

```
~/v2ray/
├── v2ray                    # V2Ray 主程序
├── config.json              # 当前配置文件
├── servers_all.json         # 所有服务器配置
├── subscription.txt         # 原始订阅内容
├── subscription_url.txt     # 订阅链接
├── v2ray.log                # 运行日志
├── v2ray.pid                # 进程PID文件
├── full_parser.py           # 订阅解析脚本
├── server_manager.py        # 服务器管理脚本
├── start.sh                 # 启动脚本
├── stop.sh                  # 停止脚本
├── restart.sh               # 重启脚本
├── status.sh                # 状态脚本
├── switch.sh                # 切换脚本
├── update.sh                # 更新脚本
└── connect.sh               # 连接脚本
```

## 常见问题

### Q: 如何更换订阅链接？

A: 运行 `v2update` 命令，选择输入新的订阅链接即可。

### Q: 如何切换到其他服务器？

A: 运行 `v2switch` 命令，选择要切换的服务器编号。

### Q: 局域网其他设备如何连接？

A: 确保选择局域网共享模式，使用以下地址：
- SOCKS5: `socks5://用户名:密码@服务器IP:1080`
- HTTP: `http://用户名:密码@服务器IP:8080`

### Q: 如何查看当前使用的服务器？

A: 运行 `v2status` 命令，会显示当前服务器信息。

### Q: 连接失败怎么办？

A:
1. 检查 `v2status` 确认服务运行状态
2. 查看 `v2log` 检查错误日志
3. 尝试 `v2switch` 切换其他服务器
4. 运行 `v2update` 更新订阅

## 技术细节

### 支持的V2Ray版本

- **推荐版本**: v5.0+
- **最低版本**: v4.37.0
- **自动更新**: 支持自动检测和下载最新版本

### 订阅解析能力

- **编码格式**: Base64 自动解码
- **协议支持**: VMess、VLESS、Shadowsocks
- **服务器数量**: 支持大量节点解析
- **错误处理**: 自动跳过无效配置

### 性能优化

- **内存使用**: 最小化内存占用
- **CPU占用**: 智能路由减少CPU开销
- **网络优化**: 连接复用和Keep-Alive
- **DNS缓存**: 减少DNS查询延迟

## 安全说明

- **权限控制**: 无需root权限，用户级安装
- **网络安全**: 默认监听本地，可选择局域网共享
- **数据保护**: 所有配置文件仅用户可读写
- **连接安全**: 支持TLS加密传输

## 更新日志

### v3.0
- 新增VLESS协议支持
- 优化订阅解析算法
- 改进服务器管理界面
- 增强错误处理机制
- 添加连接测试功能

### v2.0
- 重构配置生成逻辑
- 支持局域网共享模式
- 添加用户认证功能
- 优化DNS配置

### v1.0
- 基础VMess支持
- 简单订阅解析
- 基本服务器切换

## 技术支持

如遇到问题，请：
1. 查看本文档的常见问题部分
2. 检查日志文件 `~/v2ray/v2ray.log`
3. 提交Issue到项目仓库

---

**注意**: 本脚本仅用于学习和研究目的，请遵守当地法律法规。